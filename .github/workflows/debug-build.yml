name: Debug build APK

on:
  pull_request_target:
    branches:
      - "main"
    paths-ignore:
      - ".gitignore"
      - "**.md"
      - "LICENSE"
      - ".idea/**"
      - ".editorconfig"
      - "images/**"
      - "metadata/**"

jobs:
  run:
    name: Build debug APK
    runs-on: macos-14

    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: "oracle"
          java-version: "17"
          cache: "gradle"

      - name: Create dummy google-services.json for CI
        run: |
          echo '{
            "project_info": {
              "project_number": "123456789",
              "project_id": "dummy-project-ci",
              "storage_bucket": "dummy-project-ci.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:123456789:android:dummy",
                  "android_client_info": {
                    "package_name": "com.matrix.multigpt"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "dummy-api-key-for-ci"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }' > app/google-services.json

      - name: Create dummy AdMob config for CI
        run: |
          mkdir -p app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="admob_app_id">ca-app-pub-3940256099942544~3347511713</string>
              <string name="home_banner">ca-app-pub-3940256099942544/6300978111</string>
          </resources>' > app/src/main/res/values/ad_mob_config.xml

      - name: Build debug APK
        run: |
          ./gradlew assembleDebug

      - name: Upload debug APK
        uses: actions/upload-artifact@v4
        id: artifact-upload-step
        with:
          name: debug-${{ github.sha }}
          path: ${{ github.workspace }}/app/build/outputs/apk/debug/app-debug.apk

      - name: Comment APK Link
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: apk
          message: |
            Build complete! Here's the debug APK: ${{ steps.artifact-upload-step.outputs.artifact-url }}
